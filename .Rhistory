}
/* Prevent auto-scroll on focus for DataTable inputs */
.dataTables_wrapper input[type='search'] {
scroll-margin: 0 !important;
scroll-padding: 0 !important;
}
/* Custom row info styling */
.custom-row-info {
margin-top: 15px;
padding: 10px;
font-size: 14px;
color: #333;
background-color: #f9f9f9;
border: 1px solid #ddd;
border-radius: 4px;
display: inline-block;
}
.scrollable-checkbox{
overflow-y: scroll;
border: 1px solid #ccc;
padding: 1px;
background-color: #ffffff;
overscroll-behavior: contain;
}
.scrollable-checkbox::-webkit-scrollbar {
width: 15px;
}
.scrollable-checkbox::-webkit-scrollbar-track{
background-color: #ffffff;
}
.scrollable-checkbox::-webkit-scrollbar-thumb{
background-color: #e1e1e1;
border-radius: 1px;
}
.scrollable-checkbox::-webkit-scrollbar-thumb:hover{
background-color: #120101;
}
")),
shiny::tags$script(shiny::HTML("
// When Shiny connects, set up listeners and helpers
$(document).on('shiny:connected', function() {
// Prevent scroll propagation from small scrollable checkboxes
$(document).on('mousedown wheel touchstart', '.scrollable-checkbox', function(e) {
e.stopPropagation();
});
// Prevent focus events from causing scroll
$(document).on('focus', '.scrollable-checkbox input[type=\"checkbox\"]', function(e) {
e.stopPropagation();
});
// Prevent DataTables filter inputs from calling scrollIntoView
var originalScrollIntoView = Element.prototype.scrollIntoView;
Element.prototype.scrollIntoView = function(arg) {
try {
if (this.tagName === 'INPUT' && this.type === 'search' && $(this).closest('.dataTables_wrapper').length > 0) {
return false;
}
} catch (e) {}
return originalScrollIntoView.call(this, arg);
};
// Utility: move info+paginate into a top footer with retries
window.moveDTFooterToTop = function(tableId) {
try {
var tableEl = $('#' + tableId);
if (tableEl.length === 0) return false;
var wrapper = tableEl.closest('.dataTables_wrapper');
if (wrapper.length === 0) return false;
var info = wrapper.find('.dataTables_info').first();
var paginate = wrapper.find('.dataTables_paginate').first();
// *** MODULARIZATION FIX: Find pagination div by its namespaced ID ***
var topFooter = $('#pagination_' + tableId);
if (topFooter.length === 0) {
return false;
}
// Detach and append (preserve handlers)
if (info.length) topFooter.append(info.detach());
if (paginate.length) topFooter.append(paginate.detach());
return true;
} catch (e) {
console && console.warn && console.warn('moveDTFooterToTop error', e);
return false;
}
};
// Provide a retry mechanism because DT might render a bit later
window.ensureDTFooterMovedTop = function(tableId) {
var attempts = 0;
var maxAttempts = 30;
var intv = setInterval(function() {
attempts++;
if (window.moveDTFooterToTop(tableId) || attempts >= maxAttempts) {
clearInterval(intv);
}
}, 100); // try for ~3 seconds
};
// === START FIX: Corrected jQuery selector for Enter key ===
// A more robust way for modules is to find the submit button
// relative to the filter input.
$(document).on('keydown', \"input[type='text'][id$='-filter']\", function(e) {
if (e.key === 'Enter' || e.keyCode === 13) {
e.preventDefault();
// FIX: Go to the parent DIV (.form-group), then find the sibling button
var submitButton = $(this).parent().siblings(\"button[id$='-submit']\");
if (submitButton.length > 0) {
submitButton.click();
}
}
});
// === END FIX ===
});
"))
)
}
#' Internal function for data viewer tab UI
#' @param id The module's namespace ID.
#' @noRd
dataviewer_tab_ui <- function(id) {
ns <- shiny::NS(id)
shiny::tagList(
shiny::br(),
shiny::actionButton(ns("load"), "Refresh the Data"),
shiny::actionButton(ns("generate_code"), "Generate R Code"),
shiny::h4(shiny::tags$strong("Filter")),
shiny::textInput(ns("filter"), NULL, value = "", width = "40%"),
shiny::actionButton(ns("clear"), "Clear"),
shiny::actionButton(ns("submit"), "Submit"),
shiny::sidebarLayout(
shiny::sidebarPanel(
shiny::fluidRow(shiny::column(12,
shiny::checkboxInput(ns("cols_all"), shiny::h4(shiny::tags$strong("Select/Deselect All"), style = "margin: 0; overflow-wrap: break-word;"), TRUE),
shiny::div(class = "scrollable-checkbox",
style = "max-height: 350px;",
shiny::checkboxGroupInput(ns("columns"), "")
)
)),
shiny::br(),
shiny::fluidRow(shiny::column(12,
shiny::div(
style = "display: flex; justify-content: space-between; align-items: center; padding: 5px;",
shiny::h4(shiny::tags$strong("Attribute Info:"), style = "margin: 0; overflow-wrap: break-word;"),
shiny::actionLink(ns("popout_meta"), label="", icon = shiny::icon("glyphicon glyphicon-new-window",lib = "glyphicon"))
),
shiny::div(class = "scrollable-checkbox",
style = "max-height: 290px;",
shiny::tableOutput(ns("metainfo"))
)
)),
width = 2
),
shiny::mainPanel(
shiny::tags$div(
class = "table-wrapper",
shiny::tags$div(
# *** MODULARIZATION FIX: ID must be built from the namespaced DT ID ***
id = paste0("pagination_", ns("tbl")),
class = "top-footer",
shiny::div(
style = "display:flex; align-items:center; gap:8px;",
shiny::strong("Total rows:"),
shiny::textOutput(ns("totalrows"), inline = TRUE)
),
shiny::div(
style = "display:flex; align-items:center; gap:12px;",
shiny::tags$div(style = "min-width: 120px;")
)
),
shiny::tags$div(
id = ns("container"),
class = "scrollable-data-container",
DT::DTOutput(ns("tbl"))
)
)
)
),
shiny::tags$div(
class = "custom-row-info",
shiny::textOutput(ns("row_info"))
)
)
}
#' Internal function for data viewer tab server logic
#'
#' @param id The module's namespace ID.
#' @param get_data A reactive expression returning the dataset.
#' @param dataset_name A reactive expression returning the dataset's name.
#' @noRd
dataviewer_tab_server <- function(id, get_data, dataset_name) {
shiny::moduleServer(id, function(input, output, session) {
# This reactive value is now internal to the module
last_action <- shiny::reactiveVal("load")
# FIX: Add initialization flag
initialized <- shiny::reactiveVal(FALSE)
# Provide total rows output (full dataset row count)
output$totalrows <- shiny::renderText({
n <- 0L
d <- get_data()
if (!is.null(d)) {
try(n <- NROW(d), silent = TRUE)
}
format(n, big.mark = ",")
})
# FIX: Update columns checkboxes with priority and proper selection logic
shiny::observe({
shiny::req(get_data())
# Get columns and current selection state
columns <- names(get_data())
select_all <- isTRUE(input$cols_all)
# FIX: Properly respect the checkbox state
shiny::updateCheckboxGroupInput(
session, "columns",
label = NULL,
choices = columns,
selected = if (select_all) columns else NULL  # FIXED: Now respects deselect
)
# Mark as initialized after first update
if (!initialized()) {
initialized(TRUE)
}
}, priority = 100)  # High priority to ensure it runs first
# Update filter placeholder
shiny::observe({
shiny::updateTextInput(
session, "filter",
label = NULL,
value = "",
placeholder = "Enter a filter condition e.g., mpg > 20 & cyl == 6"
)
})
# Track last action
shiny::observeEvent(input$submit, {
last_action("submit")
})
shiny::observeEvent(input$clear, {
shiny::updateTextInput(session, "filter", value = "")
last_action("clear")
})
validate_filter_expression <- function(expr) {
# Basic validation: check for dangerous patterns
dangerous_patterns <- c(
"system\\(", "shell\\(", "eval\\(",
"source\\(", ":::", "assign\\("
)
if (any(sapply(dangerous_patterns, grepl, x = expr))) {
stop("Potentially unsafe expression detected")
}
# Check if it's a valid R expression
tryCatch({
parse(text = expr)
TRUE
}, error = function(e) {
stop("Invalid R syntax: ", e$message)
})
}
# Filter dataframe
filter_df <- shiny::eventReactive(
c(input$load, input$submit, input$clear),
{
shiny::req(get_data())
# Check the last action.
if (identical(last_action(), "clear")) {
return(get_data())
}
if (stringr::str_trim(input$filter) != "") {
tryCatch({
validate_filter_expression(input$filter)
dplyr::filter(get_data(), eval(parse(text = input$filter)))
}, error = function(e) {
shiny::showNotification(
paste0("Invalid filter condition: ", e$message),
type = "error",
duration = 5
)
get_data()
})
} else {
get_data()
}
}
)
# Filter code
filter_code <- shiny::reactive({
if (stringr::str_trim(input$filter) != "") {
paste0("filter(", input$filter, ")")
} else NULL
})
# Selected columns code
selected_cols_code <- shiny::reactive({
selected_cols <- input$columns
if (length(selected_cols) > 0) {
needs_quotes <- !grepl("^([a-zA-Z]|\\.[a-zA-Z_])[a-zA-Z0-9._]*$", selected_cols)
formatted_cols <- ifelse(needs_quotes,
paste0("`", selected_cols, "`"),
selected_cols)
paste0("select(", paste(formatted_cols, collapse = ", "), ")")
} else {
NULL
}
})
# Generated code - FIX: Don't add pipe when no operations
generated_code <- shiny::reactive({
has_filter <- !is.null(filter_code())
has_select <- !is.null(selected_cols_code())
# If neither filter nor select, just return the dataset name
if (!has_filter && !has_select) {
return(paste0(
"# Generated R Code\n",
"library(dplyr)\n",
dataset_name()
))
}
code_lines <- c(
"# Generated R Code",
"library(dplyr)",
paste0(dataset_name(), " |>")
)
if (has_filter) {
code_lines <- c(code_lines, paste0("  ", filter_code()))
if (has_select) {
code_lines[length(code_lines)] <- paste0(code_lines[length(code_lines)], " |>")
}
}
if (has_select) {
code_lines <- c(code_lines, paste0("  ", selected_cols_code()))
}
paste(code_lines, collapse = "\n")
})
# Show modal with code
shiny::observeEvent(input$generate_code, {
shiny::showModal(shiny::modalDialog(
title = "Generated R Code",
shiny::tags$textarea(
id = session$ns("code_output"),
rows = 10,
style = "width:100%;",
generated_code()
),
shiny::tags$br(),
shiny::actionButton(session$ns("copy_btn"), "Copy"),
easyClose = TRUE,
footer = shiny::modalButton("Close")
))
})
# Copy button
shiny::observeEvent(input$copy_btn, {
js_code <- sprintf(
"var copyText = document.getElementById('%s'); copyText.select(); document.execCommand('copy');",
session$ns("code_output")
)
shinyjs::runjs(js_code)
})
# Select columns - FIX: Require at least one column
cols_df <- shiny::reactive({
shiny::req(length(input$columns) > 0)
dplyr::select(filter_df(), dplyr::all_of(input$columns))
})
# Final dataframe - FIX: Return NULL when no columns selected
final_df <- shiny::reactive({
if (length(input$columns) == 0) {
return(NULL)
}
dplyr::mutate(
cols_df(),
# 1. Handle character/factor NAs (converting to "<NA>")
dplyr::across(
where(is.character) | where(is.factor),
~forcats::fct_drop(forcats::fct_na_value_to_level(as.factor(.x), level = "<NA>"))
)
)
})
# --- Metadata Reactives ---
att_cols <- shiny::reactive({
shiny::req(get_data())
att_list <- purrr::map(get_data(), attributes)
if (all(purrr::map_lgl(att_list, is.null))) {
return(tibble::tibble(colname = character(), att = character(), value = character()))
}
purrr::imap_dfr(att_list, function(attr, colname) {
if (is.null(attr)) return(NULL)
tibble::tibble(
colname = colname,
att = names(attr),
value = as.character(attr)
)
})
})
class_df <- shiny::reactive({
shiny::req(get_data())
dict <- tryCatch(labelled::generate_dictionary(get_data()), error = function(e) NULL)
if (is.null(dict) || nrow(dict) == 0) {
return(tibble::tibble(pos = integer(), colname = character(), col_type = character()))
}
dict |>
dplyr::mutate(colname = .data$variable) |>
dplyr::select(pos, colname, col_type)
})
meta_cols <- shiny::reactive({
shiny::req(get_data())
dplyr::left_join(class_df(), att_cols(), by = "colname") |>
dplyr::mutate(col_name = dplyr::case_when(
col_type == "int" ~ paste0("\U0001F522", colname),
col_type == "dbl" ~ paste0("\U0001F522", colname),
col_type == "chr" ~ paste0("\U0001F524", colname),
col_type == "date" ~ paste0("\U0001F4C5", colname),
col_type == "dttm" ~ paste0("\U0001F4C5\U0001F552", colname),
col_type == "Period" ~ paste0("\U0001F552", colname),
TRUE ~ paste0("\U0001F524", colname)
)) |>
dplyr::select(pos, col_name, att, value) |>
labelled::set_variable_labels(col_name = "Variable Name", att = "Attribute", value = "Value")
})
# Sidebar table renderer
output$metainfo <- shiny::renderTable({
shiny::req(get_data())
meta_cols() |>
dplyr::arrange(pos, att) |>
dplyr::group_by(col_name) |>
dplyr::mutate(col_name = ifelse(dplyr::row_number() == 1, col_name, "")) |>
dplyr::ungroup() |>
dplyr::select(col_name, att, value) |>
stats::setNames(c("Variable Name", "Attribute", "Value"))
}, bordered = TRUE)
# Observer for the pop-out modal
shiny::observeEvent(input$popout_meta, {
shiny::showModal(shiny::modalDialog(
title = paste(dataset_name(), "- Attribute Info"),
shiny::div(style = "max-height: 70vh; overflow-y: auto;",
shiny::tableOutput(session$ns("metainfo_modal"))
),
easyClose = TRUE,
footer = shiny::modalButton("Close")
))
})
# Renderer for the modal's table
output$metainfo_modal <- shiny::renderTable({
meta_cols() |>
dplyr::arrange(pos, att) |>
dplyr::group_by(col_name) |>
dplyr::mutate(col_name = ifelse(dplyr::row_number() == 1, col_name, "")) |>
dplyr::ungroup() |>
dplyr::select(col_name, att, value) |>
stats::setNames(c("Variable Name", "Attribute", "Value"))
}, bordered = TRUE)
# Render table - FIX: Handle empty column selection
output$tbl <- DT::renderDT({
df <- final_df()
if (is.null(df)) {
# Return empty data frame with message
return(DT::datatable(
data.frame(Message = "No columns selected. Please select at least one column."),
options = list(dom = 't', ordering = FALSE),
rownames = FALSE
))
}
DT::datatable(
df,
extensions = c("Buttons", "KeyTable"),
filter = "top",
class = "cell-border stripe hover nowrap",
selection = "none",
options = list(
pageLength = 10,
scroller.rowHeight = "auto",
scrollCollapse = FALSE,
autoWidth = FALSE,
searchHighlight = TRUE,
keys = TRUE,
dom = 'Bfrtip',
nullText = "<NA>",
buttons = list('copy', list(extend = 'collection', buttons = c('csv', 'excel'), text = 'Download')),
drawCallback = DT::JS(sprintf("
function(settings) {
var tableId = '%s';
if (window && window.ensureDTFooterMovedTop) {
window.ensureDTFooterMovedTop(tableId);
}
}
", session$ns("tbl"))),
initComplete = DT::JS(sprintf("
function(settings, json) {
var tableId = '%s';
if (window && window.ensureDTFooterMovedTop) {
window.ensureDTFooterMovedTop(tableId);
}
$(document).on('focus mousedown', '.dataTables_wrapper input[type=\"search\"]', function(e) {
e.stopPropagation();
});
}
", session$ns("tbl")))
)
)
})
# Safeguard observer
shiny::observe({
shiny::req(final_df())
shinyjs::runjs(sprintf("if(window && window.ensureDTFooterMovedTop){ window.ensureDTFooterMovedTop('%s'); }", session$ns("tbl")))
})
# Custom row info output
output$row_info <- shiny::renderText({
""
})
}) # End moduleServer
}
pkgdown::build_site()
stop_dataviewer()
pkgdown::build_site()
pkgdown::build_site()
pkgdown::build_site()
pkgdown::build_site()
pkgdown::build_site()
pkgdown::build_site()
dataviewer(iris, mtcars)
pkgdown::build_site()
id <- dataviewer(iris, mtcars)
stop_dataviewer(id = id)
